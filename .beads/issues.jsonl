{"id":"bumicert-platform-6z9","title":"CRITICAL: allowedPDSDomains config doesn't match spec — only one domain per environment","description":"## Problem\n\nTask bumicert-platform-qi7.1 spec clearly stated:\n\n\u003e In `config/gainforest-sdk.ts`, change the `allowedPDSDomains` array to put `\"gainforest.id\"` FIRST (it is the primary domain going forward), with `\"climateai.org\"` second\n\nThe spec expected:\n```typescript\nexport const allowedPDSDomains = [\n  \"gainforest.id\",\n  \"climateai.org\",\n] satisfies SupportedPDSDomain[];\n```\n\nBut the actual implementation is:\n```typescript\nexport const allowedPDSDomains = (process.env.NEXT_PUBLIC_VERCEL_ENV === \"production\" ? [\"gainforest.id\"] : [\n  \"climateai.org\",\n]) satisfies SupportedPDSDomain[];\n```\n\nThis means:\n- **Production**: Only `gainforest.id` is allowed (users can't sign in with climateai.org handles)\n- **Dev**: Only `climateai.org` is allowed (users can't test gainforest.id signup)\n\n## Impact\n\n1. **Sign-in modal**: The domain selector shows only ONE option in each environment, defeating the purpose of multi-domain support\n2. **Previous sessions**: Users with climateai.org handles won't see their sessions in production\n3. **Data layer**: All ~60 call sites using `allowedPDSDomains[0]` for blob URLs and tRPC queries will target different domains in prod vs dev\n4. **Testing**: Cannot test multi-domain signup in dev environment\n\n## Fix\n\nChange `config/gainforest-sdk.ts` line 4-5 to:\n```typescript\nexport const allowedPDSDomains = [\n  \"gainforest.id\",\n  \"climateai.org\",\n] satisfies SupportedPDSDomain[];\n```\n\nRemove the environment-based conditional entirely. Both domains should be supported in all environments.\n\n## Files\n- config/gainforest-sdk.ts (modify)\n\n## Test\n```bash\ngrep -c '\"gainforest.id\"' config/gainforest-sdk.ts  # must be 1\ngrep -c '\"climateai.org\"' config/gainforest-sdk.ts  # must be 1\ngrep -c 'VERCEL_ENV' config/gainforest-sdk.ts  # must be 0\nbun run build 2\u003e\u00261 | tail -5\n```","status":"open","priority":1,"issue_type":"bug","owner":"david@gainforest.net","created_at":"2026-02-14T11:57:08.042641+13:00","created_by":"daviddao","updated_at":"2026-02-14T11:57:08.042641+13:00","dependencies":[{"issue_id":"bumicert-platform-6z9","depends_on_id":"bumicert-platform-qi7","type":"discovered-from","created_at":"2026-02-14T11:57:11.101384+13:00","created_by":"daviddao"}]}
{"id":"bumicert-platform-8yr","title":"Build failing on feature/multi-domain-signup branch - unrelated to qi7.5 changes","description":"The build command 'bun run build' is failing with errors in /api/privy/pregen and /api/supabase/drafts/bumicert routes. This is a pre-existing issue on the feature/multi-domain-signup branch, not caused by the qi7.5 changes to oauth.ts. The qi7.5 implementation is correct and the function signature test passes.","status":"closed","priority":2,"issue_type":"bug","owner":"satyam2.climateai.org","created_at":"2026-02-14T11:37:11.624916+13:00","created_by":"satyam2.climateai.org","updated_at":"2026-02-14T11:50:23.296887+13:00","closed_at":"2026-02-14T11:50:23.296887+13:00","close_reason":"0000000 Pre-existing build issue unrelated to multi-domain work"}
{"id":"bumicert-platform-aya","title":"Sign-in modal: clicking previous session doesn't update domain selector","description":"## Problem\n\nIn `components/global/modals/sign-in.tsx` line 158-160, when a user clicks a previous session:\n\n```typescript\nonClick={() =\u003e {\n  setInputHandlePrefix(\\`${prefix}\\`);\n}}\n```\n\nThis only sets the handle prefix, but does NOT update `selectedDomain` to match the session's domain.\n\n## Current behavior\n\n1. User has previous session: `alice.climateai.org`\n2. Domain selector defaults to `gainforest.id` (allowedPDSDomains[0])\n3. User clicks the previous session → handle prefix becomes `alice`\n4. Domain selector still shows `gainforest.id`\n5. User clicks \"Sign in\" → tries to sign in as `alice.gainforest.id` instead of `alice.climateai.org`\n6. Sign-in fails (account doesn't exist on that PDS)\n\n## Expected behavior\n\nClicking a previous session should:\n1. Set the handle prefix\n2. Set the domain selector to match the session's domain\n\n## Fix\n\nUpdate the onClick handler (line 158-160):\n```typescript\nonClick={() =\u003e {\n  setInputHandlePrefix(\\`${prefix}\\`);\n  setSelectedDomain(suffix);  // Add this line\n}}\n```\n\nThe `suffix` variable is already extracted on line 140 and validated to be in `allowedPDSDomains` on line 141, so it's safe to use.\n\n## Files\n- components/global/modals/sign-in.tsx (modify)\n\n## Test\n```bash\n# Verify setSelectedDomain is called in the onClick handler\ngrep -A3 'onClick={() =\u003e {' components/global/modals/sign-in.tsx | grep setSelectedDomain\nbun run build 2\u003e\u00261 | tail -5\n```\n\n## Manual test\n1. Sign in with a climateai.org account\n2. Sign out\n3. Sign-in modal should show the previous session\n4. Click the previous session\n5. Verify domain selector shows `climateai.org`, not `gainforest.id`","status":"open","priority":2,"issue_type":"bug","owner":"david@gainforest.net","created_at":"2026-02-14T11:59:08.284682+13:00","created_by":"daviddao","updated_at":"2026-02-14T11:59:08.284682+13:00","dependencies":[{"issue_id":"bumicert-platform-aya","depends_on_id":"bumicert-platform-qi7.4","type":"discovered-from","created_at":"2026-02-14T11:59:11.899741+13:00","created_by":"daviddao"}]}
{"id":"bumicert-platform-iuw","title":"Password reset routes only target one PDS — need domain detection from email","description":"## Problem\n\nThe password reset routes hardcode `allowedPDSDomains[0]`:\n\n**request-password-reset/route.ts** (line 41):\n```typescript\nconst service = allowedPDSDomains[0];\n```\n\n**reset-password/route.ts** (line 52):\n```typescript\nconst service = allowedPDSDomains[0];\n```\n\nThis means password reset only works for users on `allowedPDSDomains[0]` PDS. Users on the other domain cannot reset their passwords.\n\n## Current behavior\n\n- User with `alice.climateai.org` handle requests password reset\n- If `allowedPDSDomains[0]` is `gainforest.id`, the request goes to the wrong PDS\n- Password reset fails (email not found on that PDS)\n\n## Expected behavior\n\nThe routes should detect which PDS the user's account is on. Options:\n\n1. **Query the invites table** to find which `pds_domain` the email was registered with\n2. **Try all allowed domains** until one succeeds (less efficient but more robust)\n3. **Add domain parameter** to the request (requires UI changes)\n\nOption 1 is cleanest if the invites table reliably tracks which PDS each email used.\n\n## Files\n- app/api/atproto/request-password-reset/route.ts (modify)\n- app/api/atproto/reset-password/route.ts (modify)\n\n## Test\n```bash\n# After fix, verify no hardcoded allowedPDSDomains[0] for service selection\ngrep -c 'service = allowedPDSDomains\\[0\\]' app/api/atproto/request-password-reset/route.ts  # must be 0\ngrep -c 'service = allowedPDSDomains\\[0\\]' app/api/atproto/reset-password/route.ts  # must be 0\nbun run build 2\u003e\u00261 | tail -5\n```","status":"open","priority":2,"issue_type":"task","owner":"david@gainforest.net","created_at":"2026-02-14T11:57:59.922323+13:00","created_by":"daviddao","updated_at":"2026-02-14T11:57:59.922323+13:00","dependencies":[{"issue_id":"bumicert-platform-iuw","depends_on_id":"bumicert-platform-qi7","type":"discovered-from","created_at":"2026-02-14T11:58:03.047239+13:00","created_by":"daviddao"}]}
{"id":"bumicert-platform-jvn","title":"Investigate: Are blob URLs cross-PDS compatible or do they need DID-to-PDS resolution?","description":"## Context\n\nThere are ~60 call sites using `allowedPDSDomains[0]` for blob URL resolution via `getBlobUrl(did, blob, allowedPDSDomains[0])`.\n\nNow that `allowedPDSDomains[0]` can be either `gainforest.id` or `climateai.org` (depending on environment in current broken config, or user choice after fix), we need to verify blob URLs work correctly.\n\n## Question\n\nWhen calling `getBlobUrl(did, blob, pdsDomain)`:\n- Does `pdsDomain` need to match the PDS where the DID's account actually lives?\n- Or can any PDS serve blobs for any DID (cross-PDS blob resolution)?\n\n## Test scenarios\n\n1. User with `alice.climateai.org` uploads an image → blob stored on climateai.org PDS\n2. Another user views that image → code calls `getBlobUrl(alice-did, blob, \"gainforest.id\")`\n3. Does the blob URL work? Or does it 404 because the blob is on climateai.org, not gainforest.id?\n\n## Expected behavior (ATProto spec)\n\nAccording to ATProto, blobs are stored on the PDS that hosts the DID. The blob URL should be:\n```\nhttps://{did-pds}/xrpc/com.atproto.sync.getBlob?did={did}\u0026cid={cid}\n```\n\nThis means we need to resolve which PDS hosts each DID, not just use `allowedPDSDomains[0]`.\n\n## Suggested fix (if cross-PDS doesn't work)\n\nCreate a helper function:\n```typescript\nfunction getPDSForDID(did: string): AllowedPDSDomain {\n  // Option 1: Parse handle from DID document (requires DID resolution)\n  // Option 2: Query database for which PDS the user signed up on\n  // Option 3: Try all allowedPDSDomains until one returns the blob (inefficient)\n  // Option 4: Store pds_domain in user session/profile\n}\n```\n\nThen replace all `getBlobUrl(did, blob, allowedPDSDomains[0])` with `getBlobUrl(did, blob, getPDSForDID(did))`.\n\n## Files to check\n- All ~60 files using `getBlobUrl(..., allowedPDSDomains[0])`\n- components/actions/oauth.ts line 158 (avatar URL)\n- lib/shapefile.ts line 18\n- app/(upload)/upload/organization/[did]/_components/Hero/index.tsx lines 79, 84, 87, 92\n- (and 50+ more)\n\n## Test\n1. Create account on gainforest.id, upload image\n2. Sign in with climateai.org account (or vice versa)\n3. Try to view the image\n4. Check browser network tab for 404s on blob URLs\n\n## Priority\n\nP3 for now — this might already work if ATProto PDS instances proxy blob requests. But needs investigation before declaring the epic complete.","status":"open","priority":3,"issue_type":"task","owner":"david@gainforest.net","created_at":"2026-02-14T11:58:41.895766+13:00","created_by":"daviddao","updated_at":"2026-02-14T11:58:41.895766+13:00","dependencies":[{"issue_id":"bumicert-platform-jvn","depends_on_id":"bumicert-platform-qi7","type":"discovered-from","created_at":"2026-02-14T11:58:45.312456+13:00","created_by":"daviddao"}]}
{"id":"bumicert-platform-qi7","title":"Epic: Multi-domain signup — support gainforest.id alongside climateai.org","description":"Allow users to choose between gainforest.id and climateai.org (formerly) when signing up and signing in. These are two separate PDS instances (did:web:climateai.org and did:web:gainforest.id) both requiring invite codes. The SDK already supports both domains as SupportedPDSDomain. The platform needs UI domain selector, per-domain PDS routing for account creation and invite codes, and elimination of hardcoded climateai.org references.","status":"closed","priority":1,"issue_type":"epic","owner":"satyam2.climateai.org","created_at":"2026-02-14T11:25:13.387397+13:00","created_by":"satyam2.climateai.org","updated_at":"2026-02-14T11:50:43.557129+13:00","closed_at":"2026-02-14T11:50:43.557129+13:00","close_reason":"b3577fb All 7 child tasks complete: multi-domain signup with gainforest.id + climateai.org selector"}
{"id":"bumicert-platform-qi7.1","title":"Add gainforest.id to allowedPDSDomains config and next.config.ts image patterns","description":"## Files\n- config/gainforest-sdk.ts (modify)\n- next.config.ts (modify)\n\n## What to do\n1. In `config/gainforest-sdk.ts`, change the `allowedPDSDomains` array to put `\"gainforest.id\"` FIRST (it is the primary domain going forward), with `\"climateai.org\"` second:\n```typescript\nexport const allowedPDSDomains = [\n  \"gainforest.id\",\n  \"climateai.org\",\n] satisfies SupportedPDSDomain[];\n```\n\n2. In `next.config.ts`, add a second entry to `images.remotePatterns` for `hostname: \"gainforest.id\"` alongside the existing `climateai.org` entry. Keep both.\n\n3. Verify TypeScript compiles: the SDK type `SupportedPDSDomain` already includes `\"gainforest.id\"`, so `satisfies SupportedPDSDomain[]` should pass.\n\n## Test\n```bash\nbun run build 2\u003e\u00261 | tail -5\n# Must not show type errors\n```\n\nAlso verify by running:\n```bash\ngrep -c \"gainforest.id\" config/gainforest-sdk.ts  # must be \u003e= 1\ngrep -c \"gainforest.id\" next.config.ts             # must be \u003e= 1\n# gainforest.id must be first in the array\nhead -6 config/gainforest-sdk.ts  # \"gainforest.id\" should appear before \"climateai.org\"\n```\n\n## Do not\n- Remove climateai.org — it stays as a supported domain (second position)\n- Modify any other files\n- Add environment variables — this is a static config change","status":"closed","priority":2,"issue_type":"task","assignee":"satyam2.climateai.org","owner":"satyam2.climateai.org","created_at":"2026-02-14T11:25:24.374867+13:00","created_by":"satyam2.climateai.org","updated_at":"2026-02-14T11:36:07.005255+13:00","closed_at":"2026-02-14T11:36:07.005255+13:00","close_reason":"266d766 Set gainforest.id as primary PDS domain","labels":["scope:trivial"],"dependencies":[{"issue_id":"bumicert-platform-qi7.1","depends_on_id":"bumicert-platform-qi7","type":"parent-child","created_at":"2026-02-14T11:25:24.37585+13:00","created_by":"satyam2.climateai.org"}]}
{"id":"bumicert-platform-qi7.2","title":"Add helper to resolve PDS service URL from domain","description":"## Files\n- config/pds.ts (create)\n\n## What to do\nCreate a new utility module `config/pds.ts` that exports:\n\n```typescript\nimport { AllowedPDSDomain } from \"./gainforest-sdk\";\n\n/**\n * Returns the PDS service base URL for a given domain.\n * Both domains are separate PDS instances.\n */\nexport function getPDSServiceUrl(domain: AllowedPDSDomain): string {\n  return `https://${domain}`;\n}\n\n/**\n * Extracts the PDS domain from a full handle.\n * e.g. \"alice.climateai.org\" -\u003e \"climateai.org\"\n *      \"bob.gainforest.id\" -\u003e \"gainforest.id\"\n * Returns undefined if the handle does not match any allowed domain.\n */\nexport function extractDomainFromHandle(handle: string): AllowedPDSDomain | undefined {\n  // import allowedPDSDomains from gainforest-sdk config\n  // loop through allowedPDSDomains and check if handle ends with `.${domain}`\n  // return the matching domain or undefined\n}\n\n/**\n * Extracts the prefix (username) from a full handle.\n * e.g. \"alice.climateai.org\" -\u003e \"alice\"\n */\nexport function extractPrefixFromHandle(handle: string): string {\n  // split on first dot that starts a known domain suffix\n  // fallback: split on first dot\n}\n```\n\nThis utility will be used by sign-up, sign-in, create-account, invite-code, and oauth modules.\n\n## Test\n```bash\n# File must exist and export the three functions\ngrep -c \"export function getPDSServiceUrl\" config/pds.ts     # must be 1\ngrep -c \"export function extractDomainFromHandle\" config/pds.ts  # must be 1\ngrep -c \"export function extractPrefixFromHandle\" config/pds.ts  # must be 1\nbun run build 2\u003e\u00261 | tail -5  # must not show type errors\n```\n\n## Do not\n- Import anything from node_modules other than types from gainforest-sdk\n- Use environment variables — domains come from the static config\n- Put any React/UI code in this file — it is a pure utility module","status":"closed","priority":2,"issue_type":"task","owner":"satyam2.climateai.org","created_at":"2026-02-14T11:25:36.93519+13:00","created_by":"satyam2.climateai.org","updated_at":"2026-02-14T11:50:23.251275+13:00","closed_at":"2026-02-14T11:50:23.251275+13:00","close_reason":"0000000 Cancelled: no downstream tasks depend on this utility","labels":["scope:trivial"],"dependencies":[{"issue_id":"bumicert-platform-qi7.2","depends_on_id":"bumicert-platform-qi7","type":"parent-child","created_at":"2026-02-14T11:25:36.936345+13:00","created_by":"satyam2.climateai.org"}]}
{"id":"bumicert-platform-qi7.3","title":"Add domain selector to sign-up modal","description":"## Files\n- components/global/modals/sign-up.tsx (modify)\n\n## What to do\n\nAdd a domain selector to the sign-up form so users can choose between `climateai.org` and `gainforest.id`.\n\n### Implementation details:\n\n1. Import `allowedPDSDomains` (already imported) and use it to populate a dropdown/select.\n\n2. Add a new state variable:\n```typescript\nconst [selectedDomain, setSelectedDomain] = useState\u003cstring\u003e(allowedPDSDomains[0]);\n```\n\n3. Replace the hardcoded `.climateai.org` suffix in the handle input (line 159-161) with a `\u003cselect\u003e` element styled inline with the input:\n```tsx\n\u003cInputGroupAddon align=\"inline-end\" className=\"text-primary\"\u003e\n  \u003cselect\n    value={selectedDomain}\n    onChange={(e) =\u003e setSelectedDomain(e.target.value)}\n    disabled={isSigningUp}\n    className=\"bg-transparent border-none outline-none text-primary cursor-pointer text-sm\"\n  \u003e\n    {allowedPDSDomains.map((domain) =\u003e (\n      \u003coption key={domain} value={domain}\u003e.{domain}\u003c/option\u003e\n    ))}\n  \u003c/select\u003e\n\u003c/InputGroupAddon\u003e\n```\n\n4. Update the mutation body (line 58) to use `selectedDomain` instead of `allowedPDSDomains[0]`:\n```typescript\nhandle: handle.replace(/^@/, \"\").trim() + `.${selectedDomain}`,\n```\n\n5. Update the post-signup redirect to SignInModal (line 238) to use `selectedDomain`:\n```typescript\ninitialHandle={`${handle}.${selectedDomain}`}\n```\n\n## Test\n```bash\n# Verify no hardcoded .climateai.org remains in sign-up.tsx\ngrep -c \"\\.climateai\\.org\" components/global/modals/sign-up.tsx  # must be 0\n# Verify select element exists\ngrep -c \"\u003cselect\" components/global/modals/sign-up.tsx  # must be \u003e= 1\n# Verify selectedDomain state\ngrep -c \"selectedDomain\" components/global/modals/sign-up.tsx  # must be \u003e= 3\n# Build must pass\nbun run build 2\u003e\u00261 | tail -5\n```\n\n## Do not\n- Change any other modal files (sign-in.tsx is a separate task)\n- Modify the API routes\n- Add new dependencies — use a native HTML `\u003cselect\u003e` styled with Tailwind\n- Change the mutation endpoint URL — it stays as `/api/atproto/create-account`","status":"closed","priority":1,"issue_type":"task","assignee":"satyam2.climateai.org","owner":"satyam2.climateai.org","created_at":"2026-02-14T11:25:50.98192+13:00","created_by":"satyam2.climateai.org","updated_at":"2026-02-14T11:48:09.882164+13:00","closed_at":"2026-02-14T11:48:09.882164+13:00","close_reason":"455a355 Add domain selector to sign-up modal","labels":["scope:small"],"dependencies":[{"issue_id":"bumicert-platform-qi7.3","depends_on_id":"bumicert-platform-qi7","type":"parent-child","created_at":"2026-02-14T11:25:50.982892+13:00","created_by":"satyam2.climateai.org"},{"issue_id":"bumicert-platform-qi7.3","depends_on_id":"bumicert-platform-qi7.1","type":"blocks","created_at":"2026-02-14T11:26:49.826651+13:00","created_by":"satyam2.climateai.org"}]}
{"id":"bumicert-platform-qi7.4","title":"Add domain selector to sign-in modal and remove hardcoded ClimateAI references","description":"## Files\n- components/global/modals/sign-in.tsx (modify)\n\n## What to do\n\nUpdate the sign-in modal to support both domains via a selector, remove all hardcoded \"climateai.org\" / \"ClimateAI\" references, and default to gainforest.id.\n\n### Implementation details:\n\n1. Import `allowedPDSDomains` from `@/config/gainforest-sdk`.\n\n2. Add a new state variable for the selected domain (defaults to first = gainforest.id after qi7.1):\n```typescript\nconst [selectedDomain, setSelectedDomain] = useState\u003cstring\u003e(\n  allowedPDSDomains[0]\n);\n```\n\n3. If `initialHandle` is provided (e.g. from sign-up redirect), detect its domain:\n```typescript\nconst initialDomain = allowedPDSDomains.find(d =\u003e initialHandle.endsWith(`.${d}`));\n// if found, use it as default for selectedDomain\n```\n\n4. Replace line 55 (sessionStorage pending handle):\n```typescript\n// Before: `${inputHandlePrefix}.climateai.org`\n// After:\n`${inputHandlePrefix}.${selectedDomain}`\n```\n\n5. Replace line 87 (modal description):\n```typescript\n// Before: \"Sign in with your ClimateAI account\"\n// After: \"Sign in with your account\"\n```\n\n6. Replace lines 106-108 (handle input suffix) with a domain selector dropdown:\n```tsx\n\u003cInputGroupAddon align=\"inline-end\" className=\"text-primary\"\u003e\n  \u003cselect\n    value={selectedDomain}\n    onChange={(e) =\u003e setSelectedDomain(e.target.value)}\n    disabled={isRedirecting}\n    className=\"bg-transparent border-none outline-none text-primary cursor-pointer text-sm\"\n  \u003e\n    {allowedPDSDomains.map((domain) =\u003e (\n      \u003coption key={domain} value={domain}\u003e.{domain}\u003c/option\u003e\n    ))}\n  \u003c/select\u003e\n\u003c/InputGroupAddon\u003e\n```\n\n7. Replace line 124 (previous sessions filter) — show sessions from ALL allowed domains, not just one:\n```typescript\n// Before: if (suffix !== \"climateai.org\") return null;\n// After: if (!allowedPDSDomains.includes(suffix as any)) return null;\n```\n\n8. Replace line 175 (redirect text):\n```typescript\n// Before: \"You will be redirected to ClimateAI to authenticate.\"\n// After: \"You will be redirected to authenticate.\"\n```\n\n9. Replace line 190 (button text):\n```typescript\n// Before: \"Sign in with ClimateAI\"\n// After: \"Sign in\"\n```\n\n## Test\n```bash\n# Verify no hardcoded climateai.org or ClimateAI remains\ngrep -ci \"climateai\" components/global/modals/sign-in.tsx  # must be 0\n# Verify select element exists  \ngrep -c \"\u003cselect\" components/global/modals/sign-in.tsx  # must be \u003e= 1\n# Verify selectedDomain state\ngrep -c \"selectedDomain\" components/global/modals/sign-in.tsx  # must be \u003e= 3\n# Verify allowedPDSDomains is imported\ngrep -c \"allowedPDSDomains\" components/global/modals/sign-in.tsx  # must be \u003e= 2\n# Build must pass\nbun run build 2\u003e\u00261 | tail -5\n```\n\n## Do not\n- Change sign-up.tsx (separate task)\n- Change the `authorize` server action (separate task)\n- Remove the previous sessions feature — it should still work, just filter by all allowed domains\n- Add new npm dependencies","status":"closed","priority":1,"issue_type":"task","assignee":"satyam2.climateai.org","owner":"satyam2.climateai.org","created_at":"2026-02-14T11:26:06.385103+13:00","created_by":"satyam2.climateai.org","updated_at":"2026-02-14T11:44:21.813975+13:00","closed_at":"2026-02-14T11:44:21.813975+13:00","close_reason":"998f2e8 - Added domain selector dropdown to sign-in modal, removed all hardcoded ClimateAI/climateai.org references, updated previous sessions filter to show all allowed domains. All grep tests pass.","labels":["scope:small"],"dependencies":[{"issue_id":"bumicert-platform-qi7.4","depends_on_id":"bumicert-platform-qi7","type":"parent-child","created_at":"2026-02-14T11:26:06.386029+13:00","created_by":"satyam2.climateai.org"},{"issue_id":"bumicert-platform-qi7.4","depends_on_id":"bumicert-platform-qi7.1","type":"blocks","created_at":"2026-02-14T11:26:49.890689+13:00","created_by":"satyam2.climateai.org"}]}
{"id":"bumicert-platform-qi7.5","title":"Update authorize server action to accept domain parameter","description":"## Files\n- components/actions/oauth.ts (modify)\n\n## What to do\n\nUpdate the `authorize` server action to accept an optional `domain` parameter so the sign-in modal can pass the selected domain.\n\n### Implementation details:\n\n1. Change the `authorize` function signature:\n```typescript\n// Before:\nexport async function authorize(handle: string): Promise\u003c{ authorizationUrl: string }\u003e\n\n// After:\nexport async function authorize(handle: string, domain?: string): Promise\u003c{ authorizationUrl: string }\u003e\n```\n\n2. Update the handle normalization logic (lines 29-31):\n```typescript\n// Before:\nconst normalizedHandle = handle.includes(\".\")\n  ? handle\n  : `${handle}.${allowedPDSDomains[0]}`;\n\n// After:\nconst normalizedHandle = handle.includes(\".\")\n  ? handle\n  : `${handle}.${domain ?? allowedPDSDomains[0]}`;\n```\n\nThis is backward compatible — callers that do not pass `domain` get the same behavior as before.\n\nThe `getProfile` function (line 157) uses `allowedPDSDomains[0]` for blob URL resolution. This is a separate concern — blob URLs work from either PDS, so leave it as-is for now. It will be addressed in a follow-up data-layer task if needed.\n\n## Test\n```bash\n# Verify the authorize function accepts 2 params\ngrep \"export async function authorize\" components/actions/oauth.ts  # should show (handle: string, domain?: string)\n# Build must pass\nbun run build 2\u003e\u00261 | tail -5\n```\n\n## Do not\n- Change the `getProfile`, `checkSession`, or `logout` functions\n- Change any other files\n- Remove the fallback to `allowedPDSDomains[0]` — the domain param is optional for backward compat","status":"closed","priority":1,"issue_type":"task","assignee":"satyam2.climateai.org","owner":"satyam2.climateai.org","created_at":"2026-02-14T11:26:17.149693+13:00","created_by":"satyam2.climateai.org","updated_at":"2026-02-14T11:39:38.099052+13:00","closed_at":"2026-02-14T11:39:38.099052+13:00","close_reason":"a6617fb Update authorize server action to accept domain parameter","labels":["scope:trivial"],"dependencies":[{"issue_id":"bumicert-platform-qi7.5","depends_on_id":"bumicert-platform-qi7","type":"parent-child","created_at":"2026-02-14T11:26:17.150654+13:00","created_by":"satyam2.climateai.org"}]}
{"id":"bumicert-platform-qi7.6","title":"Update create-account API route to route to correct PDS based on handle domain","description":"## Files\n- app/api/atproto/create-account/route.ts (modify)\n\n## What to do\n\nThe create-account route currently always targets `allowedPDSDomains[0]` (climateai.org). It needs to detect which PDS to use based on the handle domain in the request body.\n\n### Implementation details:\n\n1. Import `allowedPDSDomains` (already imported) and `AllowedPDSDomain` from `@/config/gainforest-sdk`.\n\n2. After parsing the `handle` from the request body (line 26), extract the domain suffix:\n```typescript\n// Determine which PDS to use based on the handle suffix\nconst handleDomain = allowedPDSDomains.find(\n  (domain) =\u003e handle.endsWith(`.${domain}`)\n);\n\nif (!handleDomain) {\n  return new Response(\n    JSON.stringify({\n      error: \"BadRequest\",\n      message: `Handle must end with one of: ${allowedPDSDomains.map(d =\u003e \".\" + d).join(\", \")}`,\n    }),\n    { status: 400, headers: { \"Content-Type\": \"application/json\" } }\n  );\n}\n```\n\n3. Replace line 54:\n```typescript\n// Before:\nconst service = allowedPDSDomains[0];\n\n// After:\nconst service = handleDomain;\n```\n\nThe rest of the code (XRPC call to `https://${service}/xrpc/com.atproto.server.createAccount`) stays unchanged since `service` is already used correctly.\n\n## Test\n```bash\n# Verify allowedPDSDomains[0] is no longer used directly for service\ngrep -c \"allowedPDSDomains\\[0\\]\" app/api/atproto/create-account/route.ts  # must be 0\n# Verify handleDomain is used\ngrep -c \"handleDomain\" app/api/atproto/create-account/route.ts  # must be \u003e= 2\n# Build must pass\nbun run build 2\u003e\u00261 | tail -5\n```\n\n## Do not\n- Change the invite code validation logic\n- Change the response format\n- Add environment variables\n- Modify the database queries","status":"closed","priority":1,"issue_type":"task","assignee":"satyam2.climateai.org","owner":"satyam2.climateai.org","created_at":"2026-02-14T11:26:28.650741+13:00","created_by":"satyam2.climateai.org","updated_at":"2026-02-14T11:42:55.314473+13:00","closed_at":"2026-02-14T11:42:55.314473+13:00","close_reason":"f287feb Route create-account API to correct PDS based on handle domain","labels":["scope:small"],"dependencies":[{"issue_id":"bumicert-platform-qi7.6","depends_on_id":"bumicert-platform-qi7","type":"parent-child","created_at":"2026-02-14T11:26:28.651746+13:00","created_by":"satyam2.climateai.org"},{"issue_id":"bumicert-platform-qi7.6","depends_on_id":"bumicert-platform-qi7.1","type":"blocks","created_at":"2026-02-14T11:26:49.951448+13:00","created_by":"satyam2.climateai.org"}]}
{"id":"bumicert-platform-qi7.7","title":"Update invite-code route to use NEXT_PUBLIC_ATPROTO_SERVICE_URL and remove hardcoded climateai.org fallback","description":"## Files\n- app/api/atproto/invite-code/route.ts (modify)\n\n## What to do\n\nThe invite-code route has a hardcoded fallback to `\"https://climateai.org\"` on line 64. Since invite codes are PDS-specific and this route is admin-only, update it to require the env var or use the config.\n\n### Implementation details:\n\n1. Import `allowedPDSDomains` from `@/config/gainforest-sdk`.\n\n2. Replace line 64:\n```typescript\n// Before:\nconst service = process.env.NEXT_PUBLIC_ATPROTO_SERVICE_URL || \"https://climateai.org\";\n\n// After:\nconst service = process.env.NEXT_PUBLIC_ATPROTO_SERVICE_URL || `https://${allowedPDSDomains[0]}`;\n```\n\nThis removes the hardcoded string while keeping the same behavior. The env var override still takes priority.\n\nNote: The invite code route currently creates codes on a single PDS. Supporting multi-PDS invite code generation is a future enhancement — for now, the admin targets whichever PDS is configured via env var.\n\n## Test\n```bash\n# Verify no hardcoded climateai.org string remains\ngrep -c \"climateai.org\" app/api/atproto/invite-code/route.ts  # must be 0\n# Verify allowedPDSDomains is imported\ngrep -c \"allowedPDSDomains\" app/api/atproto/invite-code/route.ts  # must be \u003e= 1\n# Build must pass\nbun run build 2\u003e\u00261 | tail -5\n```\n\n## Do not\n- Change the invite code creation logic\n- Add a domain parameter to the POST body (future enhancement)\n- Change database queries\n- Modify the admin authentication logic","status":"closed","priority":2,"issue_type":"task","assignee":"satyam2.climateai.org","owner":"satyam2.climateai.org","created_at":"2026-02-14T11:26:38.177504+13:00","created_by":"satyam2.climateai.org","updated_at":"2026-02-14T11:44:07.455084+13:00","closed_at":"2026-02-14T11:44:07.455084+13:00","close_reason":"cbb0759 - Remove hardcoded climateai.org fallback, use allowedPDSDomains[0] instead","labels":["scope:trivial"],"dependencies":[{"issue_id":"bumicert-platform-qi7.7","depends_on_id":"bumicert-platform-qi7","type":"parent-child","created_at":"2026-02-14T11:26:38.178435+13:00","created_by":"satyam2.climateai.org"},{"issue_id":"bumicert-platform-qi7.7","depends_on_id":"bumicert-platform-qi7.1","type":"blocks","created_at":"2026-02-14T11:26:50.016675+13:00","created_by":"satyam2.climateai.org"}]}
{"id":"bumicert-platform-qi7.8","title":"Wire sign-in modal to pass selectedDomain to authorize server action","description":"## Files\n- components/global/modals/sign-in.tsx (modify)\n\n## What to do\n\nAfter tasks bumicert-platform-qi7.4 (sign-in domain selector) and bumicert-platform-qi7.5 (authorize domain param) are complete, wire them together.\n\nIn sign-in.tsx, update the `handleSignIn` function to pass the selected domain to the `authorize` server action:\n\n```typescript\n// Before (line 49):\nconst { authorizationUrl } = await authorize(inputHandlePrefix);\n\n// After:\nconst { authorizationUrl } = await authorize(inputHandlePrefix, selectedDomain);\n```\n\nThis ensures the OAuth flow targets the correct PDS for the selected domain.\n\n## Test\n```bash\n# Verify authorize is called with selectedDomain\ngrep \"authorize(inputHandlePrefix, selectedDomain)\" components/global/modals/sign-in.tsx  # must match\n# Build must pass\nbun run build 2\u003e\u00261 | tail -5\n```\n\n## Do not\n- Change the authorize function itself (already done in qi7.5)\n- Modify sign-up.tsx\n- Change the OAuth callback handling","status":"closed","priority":1,"issue_type":"task","assignee":"satyam2.climateai.org","owner":"satyam2.climateai.org","created_at":"2026-02-14T11:26:45.24041+13:00","created_by":"satyam2.climateai.org","updated_at":"2026-02-14T11:49:45.47129+13:00","closed_at":"2026-02-14T11:49:45.47129+13:00","close_reason":"b3577fb Wire sign-in modal to pass selectedDomain to authorize","labels":["scope:trivial"],"dependencies":[{"issue_id":"bumicert-platform-qi7.8","depends_on_id":"bumicert-platform-qi7","type":"parent-child","created_at":"2026-02-14T11:26:45.241234+13:00","created_by":"satyam2.climateai.org"},{"issue_id":"bumicert-platform-qi7.8","depends_on_id":"bumicert-platform-qi7.4","type":"blocks","created_at":"2026-02-14T11:26:50.080909+13:00","created_by":"satyam2.climateai.org"},{"issue_id":"bumicert-platform-qi7.8","depends_on_id":"bumicert-platform-qi7.5","type":"blocks","created_at":"2026-02-14T11:26:50.143566+13:00","created_by":"satyam2.climateai.org"}]}
{"id":"bumicert-platform-qi7.9","title":"Replace remaining hardcoded climateai references with gainforest.id or dynamic values","description":"## Files\n- components/actions/oauth.ts (modify) — JSDoc example\n- app/api/oauth/callback/route.ts (modify) — code comment\n- .env.example (modify) — comment about cookie default\n\n## What to do\n\nClean up all remaining hardcoded \"climateai\" string references outside of the sign-in/sign-up modals (those are handled by other tasks).\n\n### 1. `components/actions/oauth.ts` line 18 (JSDoc):\n```typescript\n// Before:\n* @param handle - The users ATProto handle (e.g., \"alice.climateai.org\" or just \"alice\")\n\n// After:\n* @param handle - The users ATProto handle (e.g., \"alice.gainforest.id\" or just \"alice\")\n```\n\n### 2. `app/api/oauth/callback/route.ts` line 32 (comment):\n```typescript\n// Before:\n// Using describeRepo since climateai.org PDS doesnt support resolveIdentity\n\n// After:\n// Using describeRepo since the PDS doesnt support resolveIdentity\n```\n\n### 3. `.env.example` line 46 (comment):\n```\n// Before:\n# Optional: Custom cookie name (defaults to \"climateai_session\")\n\n// After:\n# Optional: Custom cookie name (defaults to \"bumicerts_session\")\n```\n\nThese are all documentation/comment changes, no logic changes.\n\n## Test\n```bash\n# Zero remaining hardcoded climateai references in these files\ngrep -ci \"climateai\" components/actions/oauth.ts  # must be 0\ngrep -ci \"climateai\" app/api/oauth/callback/route.ts  # must be 0\ngrep -ci \"climateai\" .env.example  # must be 0\n# Build must pass\nbun run build 2\u003e\u00261 | tail -5\n```\n\n## Do not\n- Change any logic or function signatures\n- Modify sign-in.tsx or sign-up.tsx (separate tasks)\n- Modify config/gainforest-sdk.ts (separate task)\n- Modify next.config.ts (separate task)\n- Touch changeset files (.changeset/) — those are historical records","status":"closed","priority":2,"issue_type":"task","assignee":"satyam2.climateai.org","owner":"satyam2.climateai.org","created_at":"2026-02-14T11:33:06.884104+13:00","created_by":"satyam2.climateai.org","updated_at":"2026-02-14T11:37:52.72924+13:00","closed_at":"2026-02-14T11:37:52.72924+13:00","close_reason":"115be98 - Replaced all hardcoded climateai references in comments/docs with gainforest.id or generic terms","labels":["scope:trivial"],"dependencies":[{"issue_id":"bumicert-platform-qi7.9","depends_on_id":"bumicert-platform-qi7","type":"parent-child","created_at":"2026-02-14T11:33:06.885014+13:00","created_by":"satyam2.climateai.org"}]}
{"id":"bumicert-platform-rke","title":"Invite code route only targets one PDS — needs domain parameter for multi-domain support","description":"## Problem\n\nThe `/api/atproto/invite-code` route (line 65) uses:\n```typescript\nconst service = process.env.NEXT_PUBLIC_ATPROTO_SERVICE_URL || \\`https://${allowedPDSDomains[0]}\\`;\n```\n\nAnd when inserting into the database (line 113):\n```typescript\nINSERT INTO invites (email, invite_token, pds_domain)\nVALUES (${email}, ${inviteCode}, ${allowedPDSDomains[0]})\n```\n\nThis means invite codes are ONLY created on one PDS (whichever is `allowedPDSDomains[0]`). Users who want to sign up on the other domain cannot use these invite codes.\n\n## Current behavior\n\n- Admin creates invite codes → they're minted on `allowedPDSDomains[0]` PDS only\n- User tries to sign up with the other domain → invite code validation fails (code doesn't exist on that PDS)\n\n## Expected behavior\n\nThe invite code route should accept an optional `domain` parameter in the request body to specify which PDS to mint codes on. If not provided, default to `allowedPDSDomains[0]`.\n\n## Suggested fix\n\n1. Add `domain?: string` to the request body type (line 27)\n2. Validate it's in `allowedPDSDomains`\n3. Use it instead of hardcoded `allowedPDSDomains[0]` for both the XRPC call and database insert\n\n## Files\n- app/api/atproto/invite-code/route.ts (modify)\n\n## Note\n\nThis was mentioned in the epic review context but not included in the original epic scope. The epic description said \"per-domain PDS routing for invite codes\" but no child task implemented it. Task qi7.7 only removed the hardcoded fallback, it didn't add domain selection.\n\n## Test\n```bash\n# After fix, verify domain parameter is accepted\ngrep -c 'domain' app/api/atproto/invite-code/route.ts  # must be \u003e= 3\nbun run build 2\u003e\u00261 | tail -5\n```","status":"open","priority":2,"issue_type":"task","owner":"david@gainforest.net","created_at":"2026-02-14T11:57:35.107978+13:00","created_by":"daviddao","updated_at":"2026-02-14T11:57:35.107978+13:00","dependencies":[{"issue_id":"bumicert-platform-rke","depends_on_id":"bumicert-platform-qi7","type":"discovered-from","created_at":"2026-02-14T11:57:38.253841+13:00","created_by":"daviddao"}]}
