import { NextResponse } from 'next/server'
import { importJWK, exportJWK } from 'jose'

export async function GET() {
  const privateKeyJwk = process.env.ATPROTO_JWK_PRIVATE

  if (!privateKeyJwk) {
    return NextResponse.json(
      { error: 'ATPROTO_JWK_PRIVATE not configured' },
      { status: 500 }
    )
  }

  try {
    // Parse the private JWK
    const privateJwk = JSON.parse(privateKeyJwk)

    // Import the private key
    const privateKey = await importJWK(privateJwk, privateJwk.alg)

    // Export the public key
    const publicJwk = await exportJWK(privateKey)

    // Ensure the key has required fields
    const jwk = {
      ...publicJwk,
      kid: privateJwk.kid || 'key-1',
      use: 'sig',
      alg: privateJwk.alg || 'ES256',
    }

    // Remove private key fields
    delete (jwk as any).d
    delete (jwk as any).p
    delete (jwk as any).q
    delete (jwk as any).dp
    delete (jwk as any).dq
    delete (jwk as any).qi

    const jwks = {
      keys: [jwk],
    }

    return NextResponse.json(jwks, {
      headers: {
        'Content-Type': 'application/json',
        'Cache-Control': 'public, max-age=3600',
      },
    })
  } catch (error) {
    console.error('Failed to generate JWKS:', error)
    return NextResponse.json(
      { error: 'Failed to generate JWKS' },
      { status: 500 }
    )
  }
}
